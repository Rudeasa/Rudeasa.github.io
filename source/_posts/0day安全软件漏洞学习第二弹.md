---
title: 0day安全软件漏洞学习第二弹
date: 2022-04-03 16:57:47
tags:
    - 漏洞学习
---

<!--more-->

​		前两天继续看了《0day安全软件漏洞分析》的第二章和第三章，分别是栈溢出原理与实践和开发shellcode的艺术，其实这些知识点自己在接触栈溢出漏洞时已经掌握得差不多了，但是还是慢慢地看了一遍王清老师讲的知识点，也算查漏补缺吧。

​		其中看完第二章，自我感觉大致上是没啥好记录学习的，因为都学会了，但是如果作为新手去学，还是很推荐的。

​		那我主要集中来记录一下第三章学到的一些小知识点（是我未掌握或者没有理解透彻的地方）。

# shellcode

​		第三章主要讲的是shellcode，其实早就很熟悉这个东西了，就是一段可以获得shell控制权的代码，大部分内容我觉得都掌握了，有个小知识点还是刚了解——堆喷射技术。

## 堆喷射（Heap Spary技术）	

​		根据书上介绍，自己总结的就是：讲EXP藏在一段很长的nop区域里面，只要程序走到这片区域，即可运行exp；因为根据文中之前介绍，程序如果开启pie，那我们的exp不是百分百命中的。虽然如果这是CTF，我们遇到pie肯定都是先泄露函数地址，再根据函数地址来计算偏移以及系统函数的真实地址，再找一些与系统函数地址相近的函数把它覆盖它以达到精确使用系统函数的效果；但是感觉CTF毕竟是一种训练题，与真实的程序可能有点差别，这本书的例子都是以真实例子来讲（可能一开始的例子比较简单），这时候可能我们做不到百分百命中exp，就需要堆喷射这样的技术来提高exp的命中率。

​		而且书中也还讲了函数返回地址的偏移按双字（DWORD）不定，可以用一片连续的跳转指令的地址来覆盖函数返回地址，只要其中有一个能够成功覆盖，shellcode就可以得到执行。

![image-20220403160825085](https://s2.loli.net/2022/04/03/nsbWgNZeTqFV8LJ.png)

现在也只是大概的了解一下这种技术，具体应该会在后续再深入学习。

## strcat 漏洞

由strcat产生的漏洞

```
…… 
strcat(“程序安装目录”，输入字符串)； 
…… 
```

而不同的主机可能会有不同的程序安装目录。例如：

```
c:\failwest\ 
c:\failwestq\ 
c:\failwestqq\ 
c:\failwestqqq\ 
```

这样，函数返回地址距离我们输入的字符串的偏移在不同的计算机上就有可能按照字节错位

![image-20220403161321396](https://s2.loli.net/2022/04/03/aYrlbxIJgmiP5FD.png)

​		图3.3.6中本想把函数返回地址覆盖为0x7C81CDDA处的跳转地址，在本机调试通过后，有可能会由于其他计算机上作为字符串前半部分的程序安装目录不同，而使覆盖的地址错位失效。这样，我们精心设计的exploit在别的计算机上可能只有1/4的成功率，通用性大大降低。 

​		解决这种尴尬情况的一个办法是使用按字节相同的双字跳转地址，甚至可以使用堆中的地址，然后想办法将shellcode用**堆扩展**的办法放置在相应的区域。

![image-20220403161406775](https://s2.loli.net/2022/04/03/XJT7kx3nuFyZmPg.png)

这也是一种利用堆喷射解决的一种问题。
